#Â sysmon install (https://github.com/NVISOsecurity/ansible-sysmon)
- name: Create directory
  win_file:
    path: "{{ sysmon_install_location }}"
    state: directory
  register: result

- name: Get sysmon zip
  win_copy:
    src: "{{ sysmon_download_file }}{{ file_ext }}"
    dest: "{{ sysmon_install_location }}/{{ sysmon_download_file }}{{ file_ext }}"

- name: Unzip sysmon
  win_unzip:
    src: "{{ sysmon_install_location }}/{{ sysmon_download_file }}{{ file_ext }}"
    dest: "{{ sysmon_install_location }}"

- name: Copy sysmon config
  win_copy:
    src: sysmonconfig-export.xml
    dest: c:\sysmon\sysmonconfig-export.xml

# RUN sysmon
- name: check sysmon service
  win_service:
    name: sysmon64
  register: result
  failed_when: result is not defined
  ignore_errors: yes

- name: Run sysmon
  win_command: "{{ sysmon_install_location }}\\sysmon64.exe -accepteula -i {{ sysmon_install_location }}\\sysmonconfig-export.xml"
  args:
    chdir: "{{ sysmon_install_location }}"
  when: result.state is not defined or result.name is not defined

  - name: "Install Wazuh Agent"
  hosts: all:!goad-ansible
  tasks:
    - name: "Download and Install Wazuh Agent"
      win_shell: |
        Invoke-WebRequest -Uri https://packages.wazuh.com/4.x/windows/wazuh-agent-4.3.11-1.msi -OutFile ${env:tmp}\wazuh-agent-4.3.11.msi; msiexec.exe /i ${env:tmp}\wazuh-agent-4.3.11.msi /q WAZUH_MANAGER='192.168.56.100' WAZUH_REGISTRATION_SERVER='192.168.56.100'
- name: "Update ossec config file and restart Wazuh Service"
  hosts: elk_log
  tasks:
    - name: "Stop Wazuh Service"
      win_service:
        name: WazuhSvc
        state: stopped

    - name: "Copy ossec.conf file"
      win_copy:
        src: /opt/goad/ansible/ossec.conf
        dest: "C:\\Program Files (x86)\\ossec-agent\\ossec.conf"

    - name: "Start Wazuh Service"
      win_service:
        name: WazuhSvc
        state: started

